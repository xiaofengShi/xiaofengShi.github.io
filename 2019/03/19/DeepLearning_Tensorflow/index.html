<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/panda_32px.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/panda_16px.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-mac-osx.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://xiaofengshi.com').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="本篇主要记录在日常工作中遇到的TensorFlow的相关信息，包括如何处理报错信息，环境设置，训练测试，数据等等。">
<meta property="og:type" content="article">
<meta property="og:title" content="DeepLearning_Tensorflow">
<meta property="og:url" content="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/index.html">
<meta property="og:site_name" content="做一个有用的人">
<meta property="og:description" content="本篇主要记录在日常工作中遇到的TensorFlow的相关信息，包括如何处理报错信息，环境设置，训练测试，数据等等。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/cuda_tf.png">
<meta property="og:image" content="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/multi_gpu.png">
<meta property="og:image" content="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/ckpt.png">
<meta property="og:image" content="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/checkpoint.png">
<meta property="article:published_time" content="2019-03-19T03:47:25.000Z">
<meta property="article:modified_time" content="2020-03-05T13:52:14.000Z">
<meta property="article:author" content="ShiXiaofeng">
<meta property="article:tag" content="Tensorflow">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/cuda_tf.png">

<link rel="canonical" href="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>DeepLearning_Tensorflow | 做一个有用的人</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">做一个有用的人</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">LLM And Search</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-fw fa-calendar"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-guestbook">

    <a href="/guestbook/" rel="section"><i class="fa fa-fw fa-commenting"></i>guestbook</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/xiaofengShi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ShiXiaofeng">
      <meta itemprop="description" content="LLM,搜索,数据挖掘,深度学习相关技术记录分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="做一个有用的人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          DeepLearning_Tensorflow
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-19 11:47:25" itemprop="dateCreated datePublished" datetime="2019-03-19T11:47:25+08:00">2019-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-05 21:52:14" itemprop="dateModified" datetime="2020-03-05T21:52:14+08:00">2020-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tensorflow/" itemprop="url" rel="index">
                    <span itemprop="name">Tensorflow</span>
                  </a>
                </span>
            </span>

          
            <span id="/2019/03/19/DeepLearning_Tensorflow/" class="post-meta-item leancloud_visitors" data-flag-title="DeepLearning_Tensorflow" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/03/19/DeepLearning_Tensorflow/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/03/19/DeepLearning_Tensorflow/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本篇主要记录在日常工作中遇到的TensorFlow的相关信息，包括如何处理报错信息，环境设置，训练测试，数据等等。</p>
<span id="more"></span>

<h2 id="如何安装"><a href="#如何安装" class="headerlink" title="如何安装"></a>如何安装</h2><p>安装tensorflow或者ubunt时，优先使用清华镜像</p>
<p>地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/help/tensorflow/">https://mirrors.tuna.tsinghua.edu.cn/help/tensorflow/</a></p>
<p>安装教程可以参考 <a href="https://www.tensorflow.org/install/source">https://www.tensorflow.org/install/source</a></p>
<p>在安装GPU版本的时候，要安装对应的cuda和cudnn文件，详细信息可以参考NVIDIA的官网，对于CUDA 和TensorFlow-GPU的版本对照，</p>
<img src="/2019/03/19/DeepLearning_Tensorflow/cuda_tf.png" class="">

<h3 id="1-安装pipeline"><a href="#1-安装pipeline" class="headerlink" title="1. 安装pipeline"></a>1. 安装pipeline</h3><ol>
<li><p>安装NVIDIA驱动</p>
<p>使用<code>nvidia-smi</code>进行测试，如果没有该命令，需要安装，安装链接为<a href="https://www.nvidia.com/Download/index.aspx?lang=en-us">https://www.nvidia.com/Download/index.aspx?lang=en-us</a> ，如果已经安装，进入下一步 </p>
</li>
<li><p>安装cuda</p>
<ol>
<li><p>首先要查询想要安装的TensorFlow版本与cuda版本的对应关系，可以在此处查询<a href="https://www.tensorflow.org/install/source%EF%BC%8C%E5%8F%A6%E5%A4%96%EF%BC%8C%E8%A1%A5%E5%85%85TensorFlow1.14.0">https://www.tensorflow.org/install/source，另外，补充TensorFlow1.14.0</a> 对应cuda10.0</p>
</li>
<li><p>确认好版本之后在此处进行下载<a href="https://developer.nvidia.com/cuda-toolkit-archive">https://developer.nvidia.com/cuda-toolkit-archive</a> 以cuda10+linux为例，当安装的是debain版本时，选择14.04的版本，因为cuda是向下兼容的，这样可以避免出错，</p>
</li>
<li><p>推荐下载runfile的方式，安装方式如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Installation Instructions:</span><br><span class="line">Run `sudo sh cuda_10.0.130_410.48_linux.run`</span><br><span class="line">Follow the command-line prompts</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照提示一步步进行安装即可，最后在<code>.zshrc</code> 或者<code>.bashrc</code>中加入cuda的路径</p>
</li>
</ol>
</li>
<li><p>安装cudnn</p>
<ol>
<li><p>下载地址<a href="https://developer.nvidia.com/rdp/cudnn-download">https://developer.nvidia.com/rdp/cudnn-download</a></p>
</li>
<li><p>根据安装的cuda版本找到对应的cudnn版本，尽量选择runtime版本，下载完之后，进行安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i xxx.deb</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>安装tensorflow</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tensorflow-gpu=1.14.0</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="API查询"><a href="#API查询" class="headerlink" title="API查询"></a>API查询</h2><p><a href="https://www.tensorflow.org/overview?hl=zh_cn">https://www.tensorflow.org/overview?hl=zh_cn</a>该网址保存着tensorflow的实例，操作手册和api查询</p>
<h2 id="高质量仓库和博客"><a href="#高质量仓库和博客" class="headerlink" title="高质量仓库和博客"></a>高质量仓库和博客</h2><p>BLOG:</p>
<ol>
<li>总览：<a href="https://www.tensorflow.org/overview">https://www.tensorflow.org/overview</a></li>
<li>常用指令的用法：<a href="https://www.tensorflow.org/guide">https://www.tensorflow.org/guide</a></li>
<li>常见模型：<a href="https://www.tensorflow.org/tutorials">https://www.tensorflow.org/tutorials</a></li>
</ol>
<p>GITHUB：</p>
<ol>
<li>官方仓库：<a href="https://github.com/tensorflow/models/">https://github.com/tensorflow/models/</a></li>
<li>高星仓库：<a href="https://github.com/aymericdamien/TensorFlow-Examples">https://github.com/aymericdamien/TensorFlow-Examples</a></li>
</ol>
<h2 id="报错信息及处理方案"><a href="#报错信息及处理方案" class="headerlink" title="报错信息及处理方案"></a>报错信息及处理方案</h2><h3 id="CentOS安装TensorFlow-ImportError-usr-lib64-libstdc-so-6-version-CXXABI-1-3-7’-not-found"><a href="#CentOS安装TensorFlow-ImportError-usr-lib64-libstdc-so-6-version-CXXABI-1-3-7’-not-found" class="headerlink" title="CentOS安装TensorFlow:ImportError: &#x2F;usr&#x2F;lib64&#x2F;libstdc++.so.6: version CXXABI_1.3.7’ not found"></a>CentOS安装TensorFlow:ImportError: &#x2F;usr&#x2F;lib64&#x2F;libstdc++.so.6: version CXXABI_1.3.7’ not found</h3><p>也有可能是这种信息,终端启动python，执行import tensorflow的操作出现的报错信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(tf) shixiaofeng@n8-035-087:~$ python</span><br><span class="line">Python 2.7.16 |Anaconda, Inc.| (default, Mar 14 2019, 21:00:58)</span><br><span class="line">[GCC 7.3.0] on linux2</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import tensorflow as tf</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/data00/home/shixiaofeng/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/__init__.py&quot;</span>, line 24, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from tensorflow.python import *</span><br><span class="line">  File <span class="string">&quot;/data00/home/shixiaofeng/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/__init__.py&quot;</span>, line 52, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from tensorflow.core.framework.graph_pb2 import *</span><br><span class="line">  File <span class="string">&quot;/data00/home/shixiaofeng/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/core/framework/graph_pb2.py&quot;</span>, line 6, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from google.protobuf import descriptor as _descriptor</span><br><span class="line">  File <span class="string">&quot;/data00/home/shixiaofeng/anaconda2/envs/tf/lib/python2.7/site-packages/google/protobuf/descriptor.py&quot;</span>, line 47, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from google.protobuf.pyext import _message</span><br><span class="line">ImportError: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `CXXABI_1.3.9<span class="string">&#x27; not found (required by /data00/home/shixiaofeng/anaconda2/envs/tf/lib/python2.7/site-packages/google/protobuf/pyext/_message.so)</span></span><br></pre></td></tr></table></figure>

<p>遇到这种相关信息是因为动态库版本过低造成的。对于TensorFlow的model目前一般使用的是最低1.5版本，这就需要对TensorFlow进行编码的时候需要一定的动态库版本。</p>
<ul>
<li><p>处理方式：</p>
<ul>
<li>查看虚拟环境中的动态库版本，下面的代码是找到名称为tf的虚拟环境下的动态库版本  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings ~/anaconda2/envs/tf/lib/libstdc++.so.6 | grep <span class="string">&#x27;CXXABI&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>查看系统的动态库版本  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">strings /usr/lib/x86_64-linux-gnu/libstdc++.so.6 | grep <span class="string">&#x27;CXXABI&#x27;</span></span><br><span class="line">strings</span><br><span class="line">或者</span><br><span class="line">/usr/lib64/libstdc++.so.6 | grep <span class="string">&#x27;CXXABI&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>如果发现系统的动态库版本较低并且就如报错信息所言，不存在需要的动态库版本，并且虚拟环境中的动态库版本较高，这个时候将虚拟环境下的动态库文件复制到系统环境下</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># cd到系统路径</span><br><span class="line">cd /usr/lib/x86_64-linux-gnu</span><br><span class="line"># 或者</span><br><span class="line">cd /usr/lib64</span><br><span class="line"># 查询libstd++版本文件</span><br><span class="line">find . -name &quot;libstdc++&quot;</span><br><span class="line"># 复制动态库文件到系统目录</span><br><span class="line">sudo cp ~/anaconda2/envs/tf/lib/libstdc++.so.6.0.25 /usr/lib/x86_64-linux-gnu/</span><br><span class="line"># /usr/lib/x86_64-linux-gnu/目录下在创建软连接</span><br><span class="line">ln -snf ./libstdc++.so.6.0.25 ./libstdc++.so.6</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="查看tf在cpu还是gpu"><a href="#查看tf在cpu还是gpu" class="headerlink" title="查看tf在cpu还是gpu"></a>查看tf在cpu还是gpu</h3><p>激活环境</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">a = tf.constant([<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">6.0</span>], shape=[<span class="number">2</span>, <span class="number">3</span>], name=<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">b = tf.constant([<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">6.0</span>], shape=[<span class="number">3</span>, <span class="number">2</span>], name=<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">c = tf.matmul(a, b)</span><br><span class="line">sess = tf.Session(config=tf.ConfigProto(log_device_placement=<span class="literal">True</span>))</span><br><span class="line"><span class="built_in">print</span> sess.run(c)</span><br></pre></td></tr></table></figure>
<p>会得到运行信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">2019-04-03 16:20:34.035168: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA</span><br><span class="line">2019-04-03 16:20:34.833230: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 0 with properties:</span><br><span class="line">name: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582</span><br><span class="line">pciBusID: 0000:02:00.0</span><br><span class="line">totalMemory: 10.92GiB freeMemory: 10.77GiB</span><br><span class="line">2019-04-03 16:20:34.945989: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 1 with properties:</span><br><span class="line">name: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582</span><br><span class="line">pciBusID: 0000:03:00.0</span><br><span class="line">totalMemory: 10.92GiB freeMemory: 10.77GiB</span><br><span class="line">2019-04-03 16:20:35.058179: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 2 with properties:</span><br><span class="line">name: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582</span><br><span class="line">pciBusID: 0000:82:00.0</span><br><span class="line">totalMemory: 10.92GiB freeMemory: 10.77GiB</span><br><span class="line">2019-04-03 16:20:35.171617: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 3 with properties:</span><br><span class="line">name: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582</span><br><span class="line">pciBusID: 0000:83:00.0</span><br><span class="line">totalMemory: 10.92GiB freeMemory: 10.77GiB</span><br><span class="line">2019-04-03 16:20:35.173885: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1045] Device peer to peer matrix</span><br><span class="line">2019-04-03 16:20:35.173989: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1051] DMA: 0 1 2 3</span><br><span class="line">2019-04-03 16:20:35.174006: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1061] 0:   Y Y N N</span><br><span class="line">2019-04-03 16:20:35.174017: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1061] 1:   Y Y N N</span><br><span class="line">2019-04-03 16:20:35.174026: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1061] 2:   N N Y Y</span><br><span class="line">2019-04-03 16:20:35.174036: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1061] 3:   N N Y Y</span><br><span class="line">2019-04-03 16:20:35.174052: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -&gt; (device: 0, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:02:00.0, compute capability: 6.1)</span><br><span class="line">2019-04-03 16:20:35.174065: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:1) -&gt; (device: 1, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:03:00.0, compute capability: 6.1)</span><br><span class="line">2019-04-03 16:20:35.174077: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:2) -&gt; (device: 2, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:82:00.0, compute capability: 6.1)</span><br><span class="line">2019-04-03 16:20:35.174088: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:3) -&gt; (device: 3, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:83:00.0, compute capability: 6.1)</span><br><span class="line">Device mapping:</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:0 -&gt; device: 0, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:02:00.0, compute capability: 6.1</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:1 -&gt; device: 1, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:03:00.0, compute capability: 6.1</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:2 -&gt; device: 2, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:82:00.0, compute capability: 6.1</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:3 -&gt; device: 3, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:83:00.0, compute capability: 6.1</span><br><span class="line">2019-04-03 16:20:35.924911: I tensorflow/core/common_runtime/direct_session.cc:299] Device mapping:</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:0 -&gt; device: 0, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:02:00.0, compute capability: 6.1</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:1 -&gt; device: 1, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:03:00.0, compute capability: 6.1</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:2 -&gt; device: 2, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:82:00.0, compute capability: 6.1</span><br><span class="line">/job:localhost/replica:0/task:0/device:GPU:3 -&gt; device: 3, name: GeForce GTX 1080 Ti, pci bus <span class="built_in">id</span>: 0000:83:00.0, compute capability: 6.1</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span> sess.run(c)</span><br><span class="line">MatMul: (MatMul): /job:localhost/replica:0/task:0/device:GPU:0</span><br><span class="line">2019-04-03 16:20:38.192824: I tensorflow/core/common_runtime/placer.cc:874] MatMul: (MatMul)/job:localhost/replica:0/task:0/device:GPU:0</span><br><span class="line">b: (Const): /job:localhost/replica:0/task:0/device:GPU:0</span><br><span class="line">2019-04-03 16:20:38.192864: I tensorflow/core/common_runtime/placer.cc:874] b: (Const)/job:localhost/replica:0/task:0/device:GPU:0</span><br><span class="line">a: (Const): /job:localhost/replica:0/task:0/device:GPU:0</span><br><span class="line">2019-04-03 16:20:38.192885: I tensorflow/core/common_runtime/placer.cc:874] a: (Const)/job:localhost/replica:0/task:0/device:GPU:0</span><br><span class="line">[[22. 28.]</span><br><span class="line"> [49. 64.]]</span><br></pre></td></tr></table></figure>
<h3 id="anaconda虚拟环境添加路径"><a href="#anaconda虚拟环境添加路径" class="headerlink" title="anaconda虚拟环境添加路径"></a>anaconda虚拟环境添加路径</h3><p>如果是个人创建的环境，则目录为，针对的是anaconda2，当然要根据自己安装的anaconda版本确定路径。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/anaconda2/envs/tf/lib/python2.7/site-packages</span><br></pre></td></tr></table></figure>
<p>如果是base环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/anaconda2/lib/python2.7/site-packages</span><br></pre></td></tr></table></figure>
<p>在目录下创建文件<code>*.pth</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim add_path.pth</span><br></pre></td></tr></table></figure>
<p>在文件下添加内容，如下针对的是对于目前本人使用的开发机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data00/home/xxx/repos/toutiao/lib/</span><br><span class="line">/data00/home/xxx/repos/toutiao/tools/rpc-tool</span><br><span class="line">/data00/home/xxx/ow_package/Theano</span><br></pre></td></tr></table></figure>
<p>如果想要cuda路径信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加cuda8路径</span></span><br><span class="line">/usr/local/cuda-8.0/bin/</span><br><span class="line">/usr/local/cuda-8.0/lib64</span><br></pre></td></tr></table></figure>
<p>也可以直接添加到<code>~/.bashrc</code>中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/local/cuda-8.0/bin/:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/cuda-8.0/lib64:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure>
<h3 id="无法导入tensorflow"><a href="#无法导入tensorflow" class="headerlink" title="无法导入tensorflow"></a>无法导入tensorflow</h3><p>已经安装<code>tensorflow</code>，但是在import的时候会出现<code>no module name tensorflow</code>的错误信息</p>
<p><strong>卸载tensorflow并重新安装</strong></p>
<h2 id="多GPU使用"><a href="#多GPU使用" class="headerlink" title="多GPU使用"></a>多GPU使用</h2><h3 id="Train"><a href="#Train" class="headerlink" title="Train"></a>Train</h3><p>官方的参考链接</p>
<p><a href="https://www.tensorflow.org/guide/using_gpu#using_multiple_gpus">https://www.tensorflow.org/guide/using_gpu#using_multiple_gpus</a></p>
<p><a href="https://www.tensorflow.org/alpha/guide/using_gpu?hl=zh_cn#using_multiple_gpus">https://www.tensorflow.org/alpha/guide/using_gpu?hl=zh_cn#using_multiple_gpus</a></p>
<p>官方代码，存在于tensorflow&#x2F;model&#x2F;</p>
<p>这个说的就是并行化，一般是模型并行化和数据并行化</p>
<ul>
<li>模型并行化：不同的gpu保存的模型不同，输入的数据相同，共同训练，可以认为是一种bagging，一般Deeplearning用的不多</li>
<li>数据并行化：不同的gpu保存的模型是相同，输入的数据不同，共同训练，指定一个device来保存模型参数，分配给使用的gpu模型中，使用所有模型的平均梯度来进行参数更新，一般用的是这种方式。</li>
</ul>
<img src="/2019/03/19/DeepLearning_Tensorflow/multi_gpu.png" class="" title="多GPU训练数据流">

<p><strong>使用Minist进行多GPU试验</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib <span class="keyword">import</span> slim</span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"><span class="comment"># 读取minist数据集</span></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">&quot;/tmp/mnist/&quot;</span>, one_hot=<span class="literal">True</span>)</span><br><span class="line"> </span><br><span class="line">num_gpus = <span class="number">2</span></span><br><span class="line">num_steps = <span class="number">1000</span></span><br><span class="line">learning_rate = <span class="number">0.001</span></span><br><span class="line">batch_size = <span class="number">1000</span></span><br><span class="line">display_step = <span class="number">10</span></span><br><span class="line"> </span><br><span class="line">num_input = <span class="number">784</span></span><br><span class="line">num_classes = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义minist训练网络</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv_net_with_layers</span>(<span class="params">x,is_training,dropout = <span class="number">0.75</span></span>):</span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(<span class="string">&quot;ConvNet&quot;</span>, reuse=tf.AUTO_REUSE):</span><br><span class="line">        x = tf.reshape(x, [-<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line">        x = tf.layers.conv2d(x, <span class="number">12</span>, <span class="number">5</span>, activation=tf.nn.relu)</span><br><span class="line">        x = tf.layers.max_pooling2d(x, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        x = tf.layers.conv2d(x, <span class="number">24</span>, <span class="number">3</span>, activation=tf.nn.relu)</span><br><span class="line">        x = tf.layers.max_pooling2d(x, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        x = tf.layers.flatten(x)</span><br><span class="line">        x = tf.layers.dense(x, <span class="number">100</span>)</span><br><span class="line">        x = tf.layers.dropout(x, rate=dropout, training=is_training)</span><br><span class="line">        out = tf.layers.dense(x, <span class="number">10</span>)</span><br><span class="line">        out = tf.nn.softmax(out) <span class="keyword">if</span> <span class="keyword">not</span> is_training <span class="keyword">else</span> out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv_net</span>(<span class="params">x,is_training</span>):</span><br><span class="line">    <span class="comment"># &quot;updates_collections&quot;: None is very import ,without will only get 0.10</span></span><br><span class="line">    batch_norm_params = &#123;<span class="string">&quot;is_training&quot;</span>: is_training, <span class="string">&quot;decay&quot;</span>: <span class="number">0.9</span>, <span class="string">&quot;updates_collections&quot;</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    <span class="comment">#,&#x27;variables_collections&#x27;: [ tf.GraphKeys.TRAINABLE_VARIABLES ]</span></span><br><span class="line">    <span class="keyword">with</span> slim.arg_scope([slim.conv2d, slim.fully_connected],</span><br><span class="line">                        activation_fn=tf.nn.relu,</span><br><span class="line">                        weights_initializer=tf.truncated_normal_initializer(mean=<span class="number">0.0</span>, stddev=<span class="number">0.01</span>),</span><br><span class="line">                        weights_regularizer=slim.l2_regularizer(<span class="number">0.0005</span>),</span><br><span class="line">                        normalizer_fn=slim.batch_norm, normalizer_params=batch_norm_params):</span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">&quot;ConvNet&quot;</span>,reuse=tf.AUTO_REUSE):</span><br><span class="line">            x = tf.reshape(x, [-<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line">            net = slim.conv2d(x, <span class="number">6</span>, [<span class="number">5</span>,<span class="number">5</span>], scope=<span class="string">&quot;conv_1&quot;</span>)</span><br><span class="line">            net = slim.max_pool2d(net, [<span class="number">2</span>, <span class="number">2</span>],scope=<span class="string">&quot;pool_1&quot;</span>)</span><br><span class="line">            net = slim.conv2d(net, <span class="number">12</span>, [<span class="number">5</span>,<span class="number">5</span>], scope=<span class="string">&quot;conv_2&quot;</span>)</span><br><span class="line">            net = slim.max_pool2d(net, [<span class="number">2</span>, <span class="number">2</span>], scope=<span class="string">&quot;pool_2&quot;</span>)</span><br><span class="line">            net = slim.flatten(net, scope=<span class="string">&quot;flatten&quot;</span>)</span><br><span class="line">            net = slim.fully_connected(net, <span class="number">100</span>, scope=<span class="string">&quot;fc&quot;</span>)</span><br><span class="line">            net = slim.dropout(net,is_training=is_training)</span><br><span class="line">            net = slim.fully_connected(net, num_classes, scope=<span class="string">&quot;prob&quot;</span>, activation_fn=<span class="literal">None</span>,normalizer_fn=<span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">return</span> net</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">average_gradients</span>(<span class="params">tower_grads</span>):</span><br><span class="line">    average_grads = []</span><br><span class="line">    <span class="keyword">for</span> grad_and_vars <span class="keyword">in</span> <span class="built_in">zip</span>(*tower_grads):</span><br><span class="line">        grads = []</span><br><span class="line">        <span class="keyword">for</span> g, _ <span class="keyword">in</span> grad_and_vars:</span><br><span class="line">            expend_g = tf.expand_dims(g, <span class="number">0</span>)</span><br><span class="line">            grads.append(expend_g)</span><br><span class="line">        grad = tf.concat(grads, <span class="number">0</span>)</span><br><span class="line">        grad = tf.reduce_mean(grad, <span class="number">0</span>)</span><br><span class="line">        v = grad_and_vars[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        grad_and_var = (grad, v)</span><br><span class="line">        average_grads.append(grad_and_var)</span><br><span class="line">    <span class="keyword">return</span> average_grads</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>():</span><br><span class="line">    <span class="keyword">with</span> tf.device(<span class="string">&quot;/cpu:0&quot;</span>):</span><br><span class="line">      	<span class="comment"># tower_grads变量保存在cpu中</span></span><br><span class="line">        global_step=tf.train.get_or_create_global_step()</span><br><span class="line">        tower_grads = []</span><br><span class="line">        </span><br><span class="line">        X = tf.placeholder(tf.float32, [<span class="literal">None</span>, num_input])</span><br><span class="line">        Y = tf.placeholder(tf.float32, [<span class="literal">None</span>, num_classes])</span><br><span class="line">        </span><br><span class="line">        opt = tf.train.AdamOptimizer(learning_rate)</span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(tf.get_variable_scope()):</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">with</span> tf.device(<span class="string">&quot;/gpu:%d&quot;</span> % i):</span><br><span class="line">                    <span class="keyword">with</span> tf.name_scope(<span class="string">&quot;tower_%d&quot;</span> % i):</span><br><span class="line">                      			<span class="comment"># 数据并行，使用该数据在当前设备下计算预测值</span></span><br><span class="line">                            _x = X[i * batch_size:(i + <span class="number">1</span>) * batch_size]</span><br><span class="line">                            _y = Y[i * batch_size:(i + <span class="number">1</span>) * batch_size]</span><br><span class="line">                            logits = conv_net(_x, <span class="literal">True</span>)</span><br><span class="line">                            tf.get_variable_scope().reuse_variables()</span><br><span class="line">                            loss = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(labels=_y, logits=logits))</span><br><span class="line">                            <span class="comment"># 根据当前模型的损失计算梯度</span></span><br><span class="line">                            grads = opt.compute_gradients(loss)</span><br><span class="line">                            <span class="comment"># 将梯度保存在临时变量tower_grads中</span></span><br><span class="line">                            tower_grads.append(grads)</span><br><span class="line">                            <span class="comment"># 使用第一个gpu进行验证，计算正确率</span></span><br><span class="line">                            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                                logits_test = conv_net(_x, <span class="literal">False</span>)</span><br><span class="line">                                correct_prediction = tf.equal(tf.argmax(logits_test, <span class="number">1</span>), tf.argmax(_y, <span class="number">1</span>))</span><br><span class="line">                                accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line">        <span class="comment"># 计算所有模型的平均梯度</span></span><br><span class="line">        grads = average_gradients(tower_grads)</span><br><span class="line">        <span class="comment"># 对优化器赋予当前的平均梯度进行参数更新</span></span><br><span class="line">        train_op = opt.apply_gradients(grads)</span><br><span class="line">        <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">            sess.run(tf.global_variables_initializer())</span><br><span class="line">            <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, num_steps + <span class="number">1</span>):</span><br><span class="line">              	<span class="comment"># 假设模型中的batch为N，使用gpu数量为M，那么每次拿到的数据为M*N</span></span><br><span class="line">								<span class="comment"># 每个模型中feed的数据量都是N</span></span><br><span class="line">                batch_x, batch_y = mnist.train.next_batch(batch_size * num_gpus)</span><br><span class="line">                sess.run(train_op, feed_dict=&#123;X: batch_x, Y: batch_y&#125;)</span><br><span class="line">                <span class="comment"># 每10次计算一次正确率</span></span><br><span class="line">                <span class="keyword">if</span> step % <span class="number">10</span> == <span class="number">0</span> <span class="keyword">or</span> step == <span class="number">1</span>:</span><br><span class="line">                    loss_value, acc = sess.run([loss, accuracy], feed_dict=&#123;X: batch_x, Y: batch_y&#125;)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;Step:&quot;</span> + <span class="built_in">str</span>(step) + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(loss_value) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(acc))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Testing Accuracy:&quot;</span>,</span><br><span class="line">                  np.mean([sess.run(accuracy, feed_dict=&#123;X: mnist.test.images[i:i + batch_size],</span><br><span class="line">                                                         Y: mnist.test.labels[i:i + batch_size]&#125;) <span class="keyword">for</span> i <span class="keyword">in</span></span><br><span class="line">                           <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(mnist.test.images), batch_size)]))</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 使用单个gpu设备进行训练</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_single</span>():</span><br><span class="line">    X = tf.placeholder(tf.float32, [<span class="literal">None</span>, num_input])</span><br><span class="line">    Y = tf.placeholder(tf.float32, [<span class="literal">None</span>, num_classes])</span><br><span class="line">    logits=conv_net(X,<span class="literal">True</span>)</span><br><span class="line">    				loss=tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(labels=Y,logits=logits))</span><br><span class="line">    opt=tf.train.AdamOptimizer(learning_rate)</span><br><span class="line">    train_op=opt.minimize(loss)</span><br><span class="line">    logits_test=conv_net(X,<span class="literal">False</span>)</span><br><span class="line">    correct_prediction = tf.equal(tf.argmax(logits_test, <span class="number">1</span>), tf.argmax(Y, <span class="number">1</span>))</span><br><span class="line">    accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">        sess.run(tf.global_variables_initializer())</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,num_steps+<span class="number">1</span>):</span><br><span class="line">            batch_x, batch_y = mnist.train.next_batch(batch_size)</span><br><span class="line">            sess.run(train_op,feed_dict=&#123;X:batch_x,Y:batch_y&#125;)</span><br><span class="line">            <span class="keyword">if</span> step%display_step==<span class="number">0</span> <span class="keyword">or</span> step==<span class="number">1</span>:</span><br><span class="line">                loss_value,acc=sess.run([loss,accuracy],feed_dict=&#123;X:batch_x,Y:batch_y&#125;)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Step:&quot;</span> + <span class="built_in">str</span>(step) + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(loss_value) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(acc))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Testing Accuracy:&quot;</span>,np.mean([sess.run(accuracy, feed_dict=&#123;X: mnist.test.images[i:i + batch_size],</span><br><span class="line">              Y: mnist.test.labels[i:i + batch_size]&#125;) <span class="keyword">for</span> i <span class="keyword">in</span></span><br><span class="line">              <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(mnist.test.images), batch_size)]))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#train_single()</span></span><br><span class="line">    train()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Eval-Inference"><a href="#Eval-Inference" class="headerlink" title="Eval &amp;&amp; Inference"></a>Eval &amp;&amp; Inference</h3><p>在验证和测试的时候，每次输入的数据是单个数据，一般情况下无法进行拆分，因此，单gpu运算。如果增加服务器来处理大量的访问请求，要调用tensorflow serving，多个gpu不熟相同的graph，由tensorflow serving来控制请求的队列。</p>
<h4 id="GPU选择"><a href="#GPU选择" class="headerlink" title="GPU选择"></a>GPU选择</h4><p>在运行tensorflow gpu时候，如果机器上存在多块显卡，并且没有在代码中进行多gpu设置，最好只用一块gpu，在运行程序的时候，可以使用如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUDA_VISIBLE_DEVICES=0 python **.py</span><br></pre></td></tr></table></figure>

<p>如此，之后使用第一块gpu进行计算。</p>
<p>当然也有其他的设置方法，可以在程序中设置TensorFlow的device环境。</p>
<h2 id="TensorRT"><a href="#TensorRT" class="headerlink" title="TensorRT"></a>TensorRT</h2><h3 id="install"><a href="#install" class="headerlink" title="install"></a>install</h3><p><a href="https://zhuanlan.zhihu.com/p/88318324">https://zhuanlan.zhihu.com/p/88318324</a></p>
<p><a href="https://tbr8.org/how-to-install-tensorrt-on-centos/">https://tbr8.org/how-to-install-tensorrt-on-centos/</a></p>
<h2 id="TfRecord"><a href="#TfRecord" class="headerlink" title="TfRecord"></a>TfRecord</h2><p>TensorFlow推荐使用tfrecord的数据格式。</p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p>将tfrecord中的数据读出，只读取一个epoch， 也就是不进行重复读取，该代码不是为了进行模型训练，只是单纯的读取tfrecord中的数据并保存本地</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tf2image</span>(<span class="params">swd,data_path</span>):</span><br><span class="line"> 		<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> 		swd: 读取的样本要保存的路径</span></span><br><span class="line"><span class="string"> 		data_path: tfrecord的路径 &#x27;xxx/xxx/*.tfrecord&#x27;格式</span></span><br><span class="line"><span class="string"> 		&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># get tfrecords</span></span><br><span class="line">    data_files = tf.gfile.Glob(data_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;data_files&#x27;</span>,data_files)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">      	<span class="comment"># generator</span></span><br><span class="line">        filename_queue = tf.train.string_input_producer(data_files,shuffle=<span class="literal">False</span>,num_epochs=<span class="number">1</span>) </span><br><span class="line">        <span class="comment"># get sample from tfrecod</span></span><br><span class="line">        reader = tf.TFRecordReader()</span><br><span class="line">        _, serialized_example = reader.read(filename_queue)   </span><br><span class="line">        features = tf.parse_single_example(serialized_example,</span><br><span class="line">                                        features=&#123;</span><br><span class="line">                                            <span class="string">&#x27;image_data&#x27;</span>: tf.FixedLenFeature([], dtype=tf.string)&#125;)  </span><br><span class="line">        image = tf.image.decode_jpeg(features[<span class="string">&#x27;image_data&#x27;</span>], channels=<span class="number">3</span>)</span><br><span class="line">        image = tf.image.convert_image_dtype(image, tf.uint8)</span><br><span class="line"></span><br><span class="line">        count=<span class="number">0</span></span><br><span class="line">        sess.run(tf.initialize_local_variables())</span><br><span class="line">        sess.run(tf.initialize_all_variables())</span><br><span class="line">        <span class="comment"># create queue</span></span><br><span class="line">        coord=tf.train.Coordinator()</span><br><span class="line">        <span class="comment"># start queue</span></span><br><span class="line">        threads = tf.train.start_queue_runners(coord=coord)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> coord.should_stop():</span><br><span class="line">                single= sess.run(image)</span><br><span class="line">                img=Image.fromarray(single, <span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line">                img.save(swd +<span class="string">&#x27;/&#x27;</span>+ <span class="built_in">str</span>(count) + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> count % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span> (<span class="string">&#x27;Alreay run %d images&#x27;</span> % count)</span><br><span class="line">        <span class="keyword">except</span> tf.errors.OutOfRangeError:</span><br><span class="line">          	<span class="comment"># if the queue is empty, break </span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Done running&#x27;</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            coord.request_stop()</span><br><span class="line">            coord.join(threads)</span><br><span class="line">       </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Fintune"><a href="#Fintune" class="headerlink" title="Fintune"></a>Fintune</h2><p>微调模型，一般指我们使用一些成型框架如VGG,GOOGLENET等，并在这个网络的基础上添加不同的网络训练层，以适应我们自己的任务。对于vgg等网络，一般是基于Imagenet预训练好的，因此我们没必要再重新从头训练，但是对于IMagenet是1000类，但是我们自己的任务很可能不是在这个数据集上进行的，为了快速训练模型，我们选用模型微调的方法。</p>
<p>加载一个预训练的模型，固定加载的这个模型的部分权重，只更新部分网络权重。</p>
<p>参考博客：<a href="https://blog.csdn.net/ying86615791/article/details/76215363">https://blog.csdn.net/ying86615791/article/details/76215363</a></p>
<p>代码来源：tensorflow yolo3</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 训练数据集</span></span><br><span class="line">trainset = dataset(parser, train_tfrecord, BATCH_SIZE, shuffle=SHUFFLE_SIZE)</span><br><span class="line">testset = dataset(parser, test_tfrecord, BATCH_SIZE, shuffle=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">is_training = tf.placeholder(tf.<span class="built_in">bool</span>)</span><br><span class="line">example = tf.cond(is_training, <span class="keyword">lambda</span>: trainset.get_next(), <span class="keyword">lambda</span>: testset.get_next())</span><br><span class="line"></span><br><span class="line">images = example[<span class="number">0</span>]</span><br><span class="line">y_true = example[<span class="number">1</span>:]</span><br><span class="line"><span class="comment"># 整个模型结构</span></span><br><span class="line">model = yolov3.yolov3(NUM_CLASSES, ANCHORS)</span><br><span class="line"><span class="keyword">with</span> tf.variable_scope(<span class="string">&#x27;yolov3&#x27;</span>):</span><br><span class="line">    <span class="comment"># pred_feature_map contains three detection feature maps</span></span><br><span class="line">    pred_feature_map = model.forward(images, is_training=is_training)</span><br><span class="line">    loss = model.compute_loss(pred_feature_map, y_true)</span><br><span class="line">    y_pred = model.predict(pred_feature_map)</span><br><span class="line"><span class="comment"># 此时graph中保存着整个网络的全部节点  </span></span><br><span class="line">graph = tf.get_default_graph()</span><br><span class="line"></span><br><span class="line">tf.summary.scalar(<span class="string">&quot;loss/coord_loss&quot;</span>,   loss[<span class="number">1</span>])</span><br><span class="line">tf.summary.scalar(<span class="string">&quot;loss/sizes_loss&quot;</span>,   loss[<span class="number">2</span>])</span><br><span class="line">tf.summary.scalar(<span class="string">&quot;loss/confs_loss&quot;</span>,   loss[<span class="number">3</span>])</span><br><span class="line">tf.summary.scalar(<span class="string">&quot;loss/class_loss&quot;</span>,   loss[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">global_step = tf.Variable(<span class="number">0</span>, trainable=<span class="literal">False</span>, collections=[tf.GraphKeys.LOCAL_VARIABLES])</span><br><span class="line">write_op = tf.summary.merge_all()</span><br><span class="line">writer_train = tf.summary.FileWriter(<span class="string">&quot;./checkpoint/summary/train&quot;</span>)</span><br><span class="line">writer_test = tf.summary.FileWriter(<span class="string">&quot;./checkpoint/summary/test&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要恢复的权重参数</span></span><br><span class="line">saver_to_restore = tf.train.Saver(var_list=tf.contrib.framework.get_variables_to_restore(</span><br><span class="line">    include=[<span class="string">&quot;yolov3/darknet-53&quot;</span>]))</span><br><span class="line"><span class="comment"># 要更新的网络参数</span></span><br><span class="line">update_vars = tf.contrib.framework.get_variables_to_restore(include=[<span class="string">&quot;yolov3/yolo-v3&quot;</span>])</span><br><span class="line">learning_rate = tf.train.exponential_decay(</span><br><span class="line">    LR, global_step, decay_steps=DECAY_STEPS, decay_rate=DECAY_RATE, staircase=<span class="literal">True</span>)</span><br><span class="line">optimizer = tf.train.AdamOptimizer(learning_rate)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只更新update_vars网络参数</span></span><br><span class="line">update_ops = tf.get_collection(tf.GraphKeys.UPDATE_OPS)</span><br><span class="line"><span class="keyword">with</span> tf.control_dependencies(update_ops):</span><br><span class="line">    train_op = optimizer.minimize(loss[<span class="number">0</span>], var_list=update_vars, global_step=global_step)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 整个模型的saver</span></span><br><span class="line">saver = tf.train.Saver(max_to_keep=<span class="number">2</span>)</span><br><span class="line"><span class="comment"># sess中的graph为整个模型的graph，很重要，这里如果不指定graph，那么sess的默认graph不会保留saver_to_restore中的节点</span></span><br><span class="line">sess = tf.Session(config=config,graph=graph)</span><br><span class="line"></span><br><span class="line">sess.run([tf.global_variables_initializer(), tf.local_variables_initializer()])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载的权重文件位置</span></span><br><span class="line">ckpt = tf.train.get_checkpoint_state(<span class="string">&quot;./checkpoint/ckpt&quot;</span>)</span><br><span class="line">saver_to_restore.restore(sess, ckpt.model_checkpoint_path)</span><br><span class="line"></span><br><span class="line">stem = os.path.splitext(os.path.basename(ckpt.model_checkpoint_path))[-<span class="number">1</span>]</span><br><span class="line">restore_iter = <span class="built_in">int</span>(stem.split(<span class="string">&#x27;-&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在tensorboard中显示graph</span></span><br><span class="line">writer_train.add_graph(sess.graph)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;resotre iter:&#x27;</span>, restore_iter</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(restore_iter, STEPS):</span><br><span class="line">    run_items = sess.run([train_op, write_op, y_pred, y_true] + loss, feed_dict=&#123;is_training: <span class="literal">True</span>&#125;)</span><br><span class="line">		<span class="comment"># 验证步数</span></span><br><span class="line">    <span class="keyword">if</span> (step+<span class="number">1</span>) % EVAL_INTERNAL == <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># calculate recall and precision</span></span><br><span class="line">        train_rec_value, train_prec_value = utils.evaluate(run_items[<span class="number">2</span>], run_items[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">    writer_train.add_summary(run_items[<span class="number">1</span>], global_step=step)</span><br><span class="line">    writer_train.flush()  <span class="comment"># Flushes the event file to disk</span></span><br><span class="line">    <span class="comment"># 保存网络权重</span></span><br><span class="line">    <span class="keyword">if</span> (step+<span class="number">1</span>) % SAVE_INTERNAL == <span class="number">0</span>:</span><br><span class="line">        saver.save(sess, save_path=<span class="string">&quot;./checkpoint/ckpt/yolov3.ckpt&quot;</span>, global_step=step + <span class="number">1</span>)</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h2 id="Export-Graph"><a href="#Export-Graph" class="headerlink" title="Export Graph"></a>Export Graph</h2><p>参考文章：</p>
<p><a href="https://blog.metaflow.fr/tensorflow-how-to-freeze-a-model-and-serve-it-with-a-python-api-d4f3596b3adc">https://blog.metaflow.fr/tensorflow-how-to-freeze-a-model-and-serve-it-with-a-python-api-d4f3596b3adc</a></p>
<p><a href="https://blog.csdn.net/guyuealian/article/details/82218092">https://blog.csdn.net/guyuealian/article/details/82218092</a></p>
<p>当训练好模型之后，默认会得到一些训练的权重文件</p>
<img src="/2019/03/19/DeepLearning_Tensorflow/ckpt.png" class="" title="模型训练得到的权重参数">

<ul>
<li>checkpoint文件保存着模型文件的路径</li>
</ul>
<img src="/2019/03/19/DeepLearning_Tensorflow/checkpoint.png" class="" title="checkpoint下保存的权重文件路径">

<ul>
<li>model.ckpt.meta保存了TensorFlow计算图的结构信息</li>
<li>model.ckpt保存每个变量的取值，此处文件名的写入方式会因不同参数的设置而不同，加载restore时的文件路径名是以checkpoint文件中的“model_checkpoint_path”值决定的</li>
</ul>
<p>在ckpt文件夹下面，存储着的信息包含着整个模型的全部信息，这些信息很显然是可以进行模型的重新加载的，但是有一些信息是没必要的，尤其是在进行测试阶段的时候，在inference的时候，只需要加载已经训练好的权重参数即可，该阶段只有正向传播，没有反向传播过程，只需要告诉模型如何输入如何输出即可，不再需要想训练阶段那样要进行模型初始化，模型保存，优化参数等设置。在tensorflow中推荐将模型进行固化的方式，只保留模型的参数。</p>
<p>具体实现代码为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># The original freeze_graph function</span></span><br><span class="line"><span class="comment"># from tensorflow.python.tools.freeze_graph import freeze_graph </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span> = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">freeze_graph</span>(<span class="params">model_dir, output_node_names</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Extract the sub graph defined by the output nodes and convert </span></span><br><span class="line"><span class="string">    all its variables into constant </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        model_dir: the root folder containing the checkpoint state file</span></span><br><span class="line"><span class="string">        output_node_names: a string, containing all the output node&#x27;s names, </span></span><br><span class="line"><span class="string">                            comma separated</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tf.gfile.Exists(model_dir):</span><br><span class="line">        <span class="keyword">raise</span> AssertionError(</span><br><span class="line">            <span class="string">&quot;Export directory doesn&#x27;t exists. Please specify an export &quot;</span></span><br><span class="line">            <span class="string">&quot;directory: %s&quot;</span> % model_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> output_node_names:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;You need to supply the name of a node to --output_node_names.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># We retrieve our checkpoint fullpath</span></span><br><span class="line">    checkpoint = tf.train.get_checkpoint_state(model_dir)</span><br><span class="line">    input_checkpoint = checkpoint.model_checkpoint_path</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># We precise the file fullname of our freezed graph</span></span><br><span class="line">    absolute_model_dir = <span class="string">&quot;/&quot;</span>.join(input_checkpoint.split(<span class="string">&#x27;/&#x27;</span>)[:-<span class="number">1</span>])</span><br><span class="line">    output_graph = absolute_model_dir + <span class="string">&quot;/frozen_model.pb&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># We clear devices to allow TensorFlow to control on which device it will load operations</span></span><br><span class="line">    <span class="comment"># if have cpu and gpu, we can load this graph on each device</span></span><br><span class="line">    clear_devices = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># We import the meta graph in the current default Graph</span></span><br><span class="line">		saver = tf.train.import_meta_graph(input_checkpoint + <span class="string">&#x27;.meta&#x27;</span>, clear_devices=clear_devices)</span><br><span class="line">    <span class="comment"># We start a session using a temporary fresh Graph</span></span><br><span class="line">    graph=tf.get_default_graph()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> tf.Session(graph=graph) <span class="keyword">as</span> sess:</span><br><span class="line">      	<span class="comment"># 模型初始化</span></span><br><span class="line">        sess.run(tf.global_variables_initializer())</span><br><span class="line">        <span class="comment"># We restore the weights</span></span><br><span class="line">        saver.restore(sess, input_checkpoint)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We use a built-in TF helper to export variables to constants</span></span><br><span class="line">        output_graph_def = tf.graph_util.convert_variables_to_constants(</span><br><span class="line">            sess, <span class="comment"># The session is used to retrieve the weights</span></span><br><span class="line">            graph.as_graph_def(), <span class="comment"># The graph_def is used to retrieve the nodes </span></span><br><span class="line">            output_node_names.split(<span class="string">&quot;,&quot;</span>) <span class="comment"># The output node names are used to select the usefull nodes</span></span><br><span class="line">        ) </span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finally we serialize and dump the output graph to the filesystem</span></span><br><span class="line">        <span class="keyword">with</span> tf.gfile.GFile(output_graph, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(output_graph_def.SerializeToString())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%d ops in the final graph.&quot;</span> % <span class="built_in">len</span>(output_graph_def.node))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output_graph_def</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--model_dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Model folder to export&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--output_node_names&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;The name of the output nodes, comma separated.&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    freeze_graph(args.model_dir, args.output_node_names)</span><br></pre></td></tr></table></figure>

<p>上述代码可以完成将ckpt中文件的固化，并输出<code>frozen_model.pb</code>文件，该文件中保存着模型的参数。</p>
<p>那么如何加载已经固化的文件呢？代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_graph</span>(<span class="params">frozen_graph_filename</span>):</span><br><span class="line">    <span class="comment"># We load the protobuf file from the disk and parse it to retrieve the </span></span><br><span class="line">    <span class="comment"># unserialized graph_def</span></span><br><span class="line">    <span class="keyword">with</span> tf.gfile.GFile(frozen_graph_filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        graph_def = tf.GraphDef()</span><br><span class="line">        graph_def.ParseFromString(f.read())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Then, we import the graph_def into a new Graph and returns it </span></span><br><span class="line">    <span class="keyword">with</span> tf.Graph().as_default() <span class="keyword">as</span> graph:</span><br><span class="line">        <span class="comment"># The name var will prefix every op/nodes in your graph</span></span><br><span class="line">        <span class="comment"># Since we load everything in a new graph, this is not needed</span></span><br><span class="line">        tf.import_graph_def(graph_def, name=<span class="string">&quot;prefix&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> graph</span><br></pre></td></tr></table></figure>

<p>加载<code>*.pb</code>文件并返回模型的graph</p>
<h2 id="下载数据集COCO-VOC"><a href="#下载数据集COCO-VOC" class="headerlink" title="下载数据集COCO&amp;VOC"></a>下载数据集COCO&amp;VOC</h2><ul>
<li><p>VOC数据集地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtrainval_06-Nov-2007.tar</span><br><span class="line">wget http://host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar</span><br><span class="line">wget http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtest_06-Nov-2007.tar</span><br></pre></td></tr></table></figure>
</li>
<li><p>COCO数据集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://images.cocodataset.org/zips/train2017.zip</span><br><span class="line">wget http://images.cocodataset.org/annotations/annotations_trainval2017.zip</span><br><span class="line">wget http://images.cocodataset.org/zips/test2017.zip</span><br><span class="line">wget http://images.cocodataset.org/annotations/image_info_test2017.zip </span><br></pre></td></tr></table></figure>


</li>
<li><p>代码实现</p>
<p>Reference  from tensorflow model</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> six.moves.urllib <span class="keyword">as</span> urllib</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">MODEL_NAME=<span class="string">&#x27;ssd_mobilenet_v2_oid_v4_2018_12_12&#x27;</span></span><br><span class="line">MODEL_FILE = MODEL_NAME + <span class="string">&#x27;.tar.gz&#x27;</span></span><br><span class="line">DOWNLOAD_BASE = <span class="string">&#x27;http://download.tensorflow.org/models/object_detection/&#x27;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;model name is:&#x27;</span>, MODEL_FILE</span><br><span class="line"><span class="comment"># Path to frozen detection graph. This is the actual model that is used for the object detection.</span></span><br><span class="line">opener = urllib.request.URLopener()</span><br><span class="line">opener.retrieve(DOWNLOAD_BASE + MODEL_FILE, MODEL_FILE)</span><br><span class="line">tar_file = tarfile.<span class="built_in">open</span>(MODEL_FILE)</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> tar_file.getmembers():</span><br><span class="line">  file_name = os.path.basename(file.name)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">&#x27;frozen_inference_graph.pb&#x27;</span> <span class="keyword">in</span> file_name:</span><br><span class="line">    tar_file.extract(file, os.getcwd())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Use the wget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> wget</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># VOC urls</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">wget http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtrainval_06-Nov-2007.tar</span></span><br><span class="line"><span class="string">wget http://host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar</span></span><br><span class="line"><span class="string">wget http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtest_06-Nov-2007.tar</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># COCO urls</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">wget http://images.cocodataset.org/zips/train2017.zip</span></span><br><span class="line"><span class="string">wget http://images.cocodataset.org/annotations/annotations_trainval2017.zip</span></span><br><span class="line"><span class="string">wget http://images.cocodataset.org/zips/test2017.zip</span></span><br><span class="line"><span class="string">wget http://images.cocodataset.org/annotations/image_info_test2017.zip </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">parser</span>(argparse.ArgumentParser):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, description</span>):</span><br><span class="line">        <span class="built_in">super</span>(parser, self).__init__(description)</span><br><span class="line"></span><br><span class="line">        self.add_argument(</span><br><span class="line">            <span class="string">&quot;--dataset&quot;</span>, <span class="string">&quot;-data&quot;</span>, default=<span class="string">&#x27;voc&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, choices=&#123;<span class="string">&#x27;voc&#x27;</span>, <span class="string">&#x27;coco&#x27;</span>&#125;,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;[default: %(default)s] The type  of dataset ...&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">voc_url = [<span class="string">&#x27;http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtrainval_06-Nov-2007.tar&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;http://host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtest_06-Nov-2007.tar&#x27;</span>]</span><br><span class="line"></span><br><span class="line">coco_url = [<span class="string">&#x27;http://images.cocodataset.org/zips/train2017.zip&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;http://images.cocodataset.org/annotations/annotations_trainval2017.zip&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;http://images.cocodataset.org/zips/test2017.zip&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;http://images.cocodataset.org/annotations/image_info_test2017.zip&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">args</span>):</span><br><span class="line">    flags = parser(description=<span class="string">&quot;Download dataset&quot;</span>).parse_args()</span><br><span class="line">    <span class="keyword">if</span> flags.dataset == <span class="string">&#x27;voc&#x27;</span>:</span><br><span class="line">        saved_path = [os.path.join(<span class="string">&#x27;/data00/home/shixiaofeng/data&#x27;</span>, <span class="string">&#x27;voc&#x27;</span>)]</span><br><span class="line">        urls = voc_url</span><br><span class="line">    <span class="keyword">elif</span> flags.dataset == <span class="string">&#x27;coco&#x27;</span>:</span><br><span class="line">        saved_path = [os.path.join(<span class="string">&#x27;/data00/home/shixiaofeng/data&#x27;</span>, <span class="string">&#x27;coco&#x27;</span>)]</span><br><span class="line">        urls = coco_url</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        saved_path = [os.path.join(<span class="string">&#x27;/data00/home/shixiaofeng/data&#x27;</span>, <span class="string">&#x27;voc&#x27;</span>),</span><br><span class="line">                      os.path.join(<span class="string">&#x27;/data00/home/shixiaofeng/data&#x27;</span>, <span class="string">&#x27;coco&#x27;</span>)]</span><br><span class="line">        urls = [voc_url, coco_url]</span><br><span class="line">    <span class="keyword">for</span> _path <span class="keyword">in</span> saved_path:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(_path):</span><br><span class="line">            os.makedirs(_path)</span><br><span class="line">    <span class="keyword">for</span> _path <span class="keyword">in</span> saved_path:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            DATA_NAME = url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Downloading %s&#x27;</span> % DATA_NAME</span><br><span class="line">            DATA_FILE = os.path.join(_path, DATA_NAME)</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Download the file to : %s&#x27;</span> %DATA_FILE</span><br><span class="line">            wget.download(url, DATA_FILE)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> url.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>] == <span class="string">&#x27;tar&#x27;</span>:</span><br><span class="line">                    tar_file = tarfile.<span class="built_in">open</span>(DATA_FILE)</span><br><span class="line">                    <span class="keyword">for</span> file_name <span class="keyword">in</span> tar_file.getnames():</span><br><span class="line">                        tar_file.extract(file_name, _path)</span><br><span class="line">                    tar_file.close()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">elif</span> url.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>] == <span class="string">&#x27;zip&#x27;</span>:</span><br><span class="line">                    zip_file = zipfile.ZipFile(DATA_FILE)</span><br><span class="line">                    <span class="keyword">for</span> file_name <span class="keyword">in</span> zip_file.namelist():</span><br><span class="line">                        zip_file.extract(file_name, _path)</span><br><span class="line">                    zip_file.close()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(sys.argv[<span class="number">1</span>:])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python xxx.py --dataset coco </span><br></pre></td></tr></table></figure>

<p>可以直接下载coco数据集到设置的位置，并将数据集解压缩</p>
<h2 id="OpenImage-下载"><a href="#OpenImage-下载" class="headerlink" title="OpenImage 下载"></a>OpenImage 下载</h2><p>由于OpenImage文件较多，单次下载非常慢，特此保存一个下载脚本，输入想要的模型名称，下载openimage中对应的数据图片和标注信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> botocore <span class="keyword">import</span> UNSIGNED</span><br><span class="line"><span class="keyword">from</span> botocore.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">import</span> botocore</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool, Manager</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>, config=Config(signature_version=UNSIGNED))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">bucket, root, retry, counter, lock, path</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    src = path</span><br><span class="line">    dest = <span class="string">&quot;&#123;root&#125;/&#123;path&#125;&quot;</span>.<span class="built_in">format</span>(root=root, path=path)</span><br><span class="line">    <span class="keyword">while</span> i &lt; retry:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dest):</span><br><span class="line">                s3.download_file(bucket, src, dest)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.info(<span class="string">&quot;&#123;dest&#125; already exists.&quot;</span>.<span class="built_in">format</span>(dest=dest))</span><br><span class="line">            <span class="keyword">with</span> lock:</span><br><span class="line">                counter.value += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> counter.value % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                    logging.warning(<span class="string">&quot;Downloaded &#123;&#125; images: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(counter.value,dest))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">except</span> botocore.exceptions.ClientError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">                logging.warning(<span class="string">&quot;The file s3://&#123;bucket&#125;/&#123;src&#125; does not exist.&quot;</span>.<span class="built_in">format</span>(bucket=bucket,src=src))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            logging.warning(<span class="string">&quot;Sleep &#123;i&#125; and try again.&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">            time.sleep(i)</span><br><span class="line">    logging.warning(<span class="string">&quot;Failed to download the file s3://&#123;bucket&#125;/&#123;src&#125;. Exception: &#123;e&#125;&quot;</span>.<span class="built_in">format</span>(bucket=bucket,src=src,e=e))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_download</span>(<span class="params">bucket, file_paths, root, num_workers=<span class="number">10</span>, retry=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">with</span> Pool(num_workers) <span class="keyword">as</span> p:</span><br><span class="line">        m = Manager()</span><br><span class="line">        counter = m.Value(<span class="string">&#x27;i&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        lock = m.Lock()</span><br><span class="line">        download_ = functools.partial(download, bucket, root, retry, counter, lock)</span><br><span class="line">        p.<span class="built_in">map</span>(download_, file_paths)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">http_download</span>(<span class="params">url, path</span>):</span><br><span class="line">    <span class="keyword">with</span> request.urlopen(url) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            buf = f.read(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">while</span> buf:</span><br><span class="line">                fout.write(buf)</span><br><span class="line">                buf = f.read(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_counts</span>(<span class="params">values</span>):</span><br><span class="line">    <span class="keyword">for</span> k, count <span class="keyword">in</span> values.value_counts().iteritems():</span><br><span class="line">        logging.warning(<span class="string">&quot;&#123;&#125;: &#123;&#125;/&#123;&#125; = &#123;:.8f&#125;.&quot;</span>.<span class="built_in">format</span>(k,count,<span class="built_in">len</span>(values),count/<span class="built_in">len</span>(values)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&#x27;Dowload open image dataset by class.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--root&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;The root directory that you want to store the open image data.&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;include_depiction&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Do you want to include drawings or depictions?&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--class_names&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;the classes you want to download.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--class_names_file&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;the classes you want to download.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--num_workers&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">10</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;the classes you want to download.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--retry&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">10</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;retry times when downloading.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--filter_file&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;This file specifies the image ids you want to exclude.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--remove_overlapped&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Remove single boxes covered by group boxes.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> parser.parse_args()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig(stream=sys.stdout, level=logging.WARNING,</span><br><span class="line">                        <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    args = parse_args()</span><br><span class="line">    bucket = <span class="string">&quot;open-images-dataset&quot;</span></span><br><span class="line">    names = [e.strip() <span class="keyword">for</span> e <span class="keyword">in</span> args.class_names.split(<span class="string">&quot;,&quot;</span>)]</span><br><span class="line">    class_names = []</span><br><span class="line">    group_filters = []</span><br><span class="line">    percentages = []</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> names:</span><br><span class="line">        t = name.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        class_names.append(t[<span class="number">0</span>].strip())</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(t) &gt;= <span class="number">2</span> <span class="keyword">and</span> t[<span class="number">1</span>].strip():</span><br><span class="line">            group_filters.append(t[<span class="number">1</span>].strip())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            group_filters.append(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(t) &gt;= <span class="number">3</span> <span class="keyword">and</span> t[<span class="number">2</span>].strip():</span><br><span class="line">            percentages.append(<span class="built_in">float</span>(t[<span class="number">2</span>].strip()))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            percentages.append(<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(args.root):</span><br><span class="line">        os.makedirs(args.root)</span><br><span class="line"></span><br><span class="line">    excluded_images = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">if</span> args.filter_file:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(args.filter_file):</span><br><span class="line">            img_id = line.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> img_id:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            excluded_images.add(img_id)</span><br><span class="line"></span><br><span class="line">    class_description_file = os.path.join(args.root, <span class="string">&quot;class-descriptions-boxable.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(class_description_file):</span><br><span class="line">        url = <span class="string">&quot;https://storage.googleapis.com/openimages/2018_04/class-descriptions-boxable.csv&quot;</span></span><br><span class="line">        logging.warning(<span class="string">&quot;Download &#123;url&#125;.&quot;</span>.<span class="built_in">format</span>(url=url))</span><br><span class="line">        http_download(url, class_description_file)</span><br><span class="line"></span><br><span class="line">    class_descriptions = pd.read_csv(class_description_file,</span><br><span class="line">                                    names=[<span class="string">&quot;id&quot;</span>, <span class="string">&quot;ClassName&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    class_names=[]</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(args.class_names_file, <span class="string">&#x27;r&#x27;</span>).readlines():</span><br><span class="line">        x=line.strip().split(<span class="string">&#x27;/&#x27;</span>) </span><br><span class="line">        x = [i.capitalize() <span class="keyword">for</span> i <span class="keyword">in</span> x]</span><br><span class="line">        class_names.extend(x)</span><br><span class="line">        </span><br><span class="line">    class_names = <span class="built_in">list</span>(<span class="built_in">set</span>(class_names))</span><br><span class="line">    </span><br><span class="line">    class_descriptions = class_descriptions[class_descriptions[<span class="string">&#x27;ClassName&#x27;</span>].isin(class_names)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;class_descriptions&#x27;</span>,class_descriptions)</span><br><span class="line">    image_files = []</span><br><span class="line">    <span class="keyword">for</span> dataset_type <span class="keyword">in</span> [<span class="string">&quot;train&quot;</span>, <span class="string">&quot;validation&quot;</span>, <span class="string">&quot;test&quot;</span>]:</span><br><span class="line">        image_dir = os.path.join(args.root, dataset_type)</span><br><span class="line">        os.makedirs(image_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        annotation_file = <span class="string">&quot;&#123;&#125;/&#123;&#125;-annotations-bbox.csv&quot;</span>.<span class="built_in">format</span>(args.root,dataset_type)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(annotation_file):</span><br><span class="line">            url = <span class="string">&quot;https://storage.googleapis.com/openimages/2018_04/&#123;&#125;/&#123;&#125;-annotations-bbox.csv&quot;</span>.<span class="built_in">format</span>(dataset_type,dataset_type)</span><br><span class="line">            logging.warning(<span class="string">&quot;Download &#123;url&#125;.&quot;</span>.<span class="built_in">format</span>(url=url))</span><br><span class="line">            http_download(url, annotation_file)</span><br><span class="line">        logging.warning(<span class="string">&quot;Read annotation file &#123;&#125;&quot;</span>.<span class="built_in">format</span>(annotation_file))</span><br><span class="line">        annotations = pd.read_csv(annotation_file)</span><br><span class="line">        annotations = pd.merge(annotations, class_descriptions,</span><br><span class="line">                               left_on=<span class="string">&quot;LabelName&quot;</span>, right_on=<span class="string">&quot;id&quot;</span>,</span><br><span class="line">                               how=<span class="string">&quot;inner&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args.include_depiction:</span><br><span class="line">            annotations = annotations.loc[annotations[<span class="string">&#x27;IsDepiction&#x27;</span>] != <span class="number">1</span>, :]</span><br><span class="line"></span><br><span class="line">        filtered = []</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;class_names&quot;</span>, class_names)</span><br><span class="line">        group_filters = [<span class="string">&#x27;~group&#x27;</span>] * <span class="built_in">len</span>(class_names)</span><br><span class="line">        percentages=[<span class="number">1.0</span>]*<span class="built_in">len</span>(class_names)</span><br><span class="line">        <span class="keyword">for</span> class_name, group_filter, percentage <span class="keyword">in</span> <span class="built_in">zip</span>(class_names, group_filters, percentages):</span><br><span class="line">            sub = annotations.loc[annotations[<span class="string">&#x27;ClassName&#x27;</span>] == class_name, :]</span><br><span class="line">            excluded_images |= <span class="built_in">set</span>(sub[<span class="string">&#x27;ImageID&#x27;</span>].sample(frac=<span class="number">1</span> - percentage))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> group_filter == <span class="string">&#x27;~group&#x27;</span>:</span><br><span class="line">                excluded_images |= <span class="built_in">set</span>(sub.loc[sub[<span class="string">&#x27;IsGroupOf&#x27;</span>] == <span class="number">1</span>, <span class="string">&#x27;ImageID&#x27;</span>])</span><br><span class="line">            <span class="keyword">elif</span> group_filter == <span class="string">&#x27;group&#x27;</span>:</span><br><span class="line">                excluded_images |= <span class="built_in">set</span>(sub.loc[sub[<span class="string">&#x27;IsGroupOf&#x27;</span>] == <span class="number">0</span>, <span class="string">&#x27;ImageID&#x27;</span>])</span><br><span class="line">            filtered.append(sub)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;annotations&quot;</span>, annotations.shape)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;filtered&quot;</span>,<span class="built_in">len</span>(filtered))</span><br><span class="line">        annotations = pd.concat(filtered)</span><br><span class="line">        annotations = annotations.loc[~annotations[<span class="string">&#x27;ImageID&#x27;</span>].isin(excluded_images), :]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> args.remove_overlapped:</span><br><span class="line">            images_with_group = annotations.loc[annotations[<span class="string">&#x27;IsGroupOf&#x27;</span>] == <span class="number">1</span>, <span class="string">&#x27;ImageID&#x27;</span>]</span><br><span class="line">            annotations = annotations.loc[~(annotations[<span class="string">&#x27;ImageID&#x27;</span>].isin(<span class="built_in">set</span>(images_with_group)) &amp; (annotations[<span class="string">&#x27;IsGroupOf&#x27;</span>] == <span class="number">0</span>)), :]</span><br><span class="line">        annotations = annotations.sample(frac=<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">        logging.warning(<span class="string">&quot;&#123;&#125; bounding boxes size: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(dataset_type,annotations.shape[<span class="number">0</span>]))</span><br><span class="line">        logging.warning(<span class="string">&quot;Approximate Image Stats: &quot;</span>)</span><br><span class="line">        log_counts(annotations.drop_duplicates([<span class="string">&quot;ImageID&quot;</span>, <span class="string">&quot;ClassName&quot;</span>])[<span class="string">&quot;ClassName&quot;</span>])</span><br><span class="line">        logging.warning(<span class="string">&quot;Label distribution: &quot;</span>)</span><br><span class="line">        log_counts(annotations[<span class="string">&#x27;ClassName&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        logging.warning(<span class="string">&quot;Shuffle dataset.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        sub_annotation_file = <span class="string">&quot;&#123;&#125;/sub-&#123;&#125;-annotations-bbox.csv&quot;</span>.<span class="built_in">format</span>(args.root,dataset_type)</span><br><span class="line">        logging.warning(<span class="string">&quot;Save &#123;&#125; data to &#123;&#125;.&quot;</span>.<span class="built_in">format</span>(dataset_type,sub_annotation_file))</span><br><span class="line">        annotations.to_csv(sub_annotation_file, index=<span class="literal">False</span>)</span><br><span class="line">        image_files.extend(<span class="string">&quot;&#123;&#125;/&#123;&#125;.jpg&quot;</span>.<span class="built_in">format</span>(dataset_type, ids) <span class="keyword">for</span> ids <span class="keyword">in</span> <span class="built_in">set</span>(annotations[<span class="string">&#x27;ImageID&#x27;</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;image_files&#x27;</span>,<span class="built_in">len</span>(image_files))</span><br><span class="line">    logging.warning(<span class="string">&quot;Start downloading &#123;&#125; images.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(image_files)))</span><br><span class="line">    batch_download(bucket, image_files, args.root, args.num_workers, args.retry)</span><br><span class="line">    logging.warning(<span class="string">&quot;Task Done.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以使用如下方法进行下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python open_images_downloader.py --root ~/datas/openimage  --class_names_file dataset/awesome_open.names  --num_workers 500</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        <div class="reward-container">
  <div>赏杯咖啡！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat.jpeg" alt="ShiXiaofeng 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpeg" alt="ShiXiaofeng 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>ShiXiaofeng
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/" title="DeepLearning_Tensorflow">http://xiaofengshi.com/2019/03/19/DeepLearning_Tensorflow/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Tensorflow/" rel="tag"># Tensorflow</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/10/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-NLP-BERT/" rel="prev" title="深度学习-NLP-BERT">
      <i class="fa fa-chevron-left"></i> 深度学习-NLP-BERT
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/03/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-OCR-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/" rel="next" title="深度学习-OCR-从零开始">
      深度学习-OCR-从零开始 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">如何安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85pipeline"><span class="nav-number">1.1.</span> <span class="nav-text">1. 安装pipeline</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.</span> <span class="nav-text">API查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E8%B4%A8%E9%87%8F%E4%BB%93%E5%BA%93%E5%92%8C%E5%8D%9A%E5%AE%A2"><span class="nav-number">3.</span> <span class="nav-text">高质量仓库和博客</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF%E5%8F%8A%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88"><span class="nav-number">4.</span> <span class="nav-text">报错信息及处理方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CentOS%E5%AE%89%E8%A3%85TensorFlow-ImportError-usr-lib64-libstdc-so-6-version-CXXABI-1-3-7%E2%80%99-not-found"><span class="nav-number">4.1.</span> <span class="nav-text">CentOS安装TensorFlow:ImportError: &#x2F;usr&#x2F;lib64&#x2F;libstdc++.so.6: version CXXABI_1.3.7’ not found</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Btf%E5%9C%A8cpu%E8%BF%98%E6%98%AFgpu"><span class="nav-number">4.2.</span> <span class="nav-text">查看tf在cpu还是gpu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#anaconda%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E6%B7%BB%E5%8A%A0%E8%B7%AF%E5%BE%84"><span class="nav-number">4.3.</span> <span class="nav-text">anaconda虚拟环境添加路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E6%B3%95%E5%AF%BC%E5%85%A5tensorflow"><span class="nav-number">4.4.</span> <span class="nav-text">无法导入tensorflow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9AGPU%E4%BD%BF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">多GPU使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Train"><span class="nav-number">5.1.</span> <span class="nav-text">Train</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eval-Inference"><span class="nav-number">5.2.</span> <span class="nav-text">Eval &amp;&amp; Inference</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GPU%E9%80%89%E6%8B%A9"><span class="nav-number">5.2.1.</span> <span class="nav-text">GPU选择</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TensorRT"><span class="nav-number">6.</span> <span class="nav-text">TensorRT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#install"><span class="nav-number">6.1.</span> <span class="nav-text">install</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TfRecord"><span class="nav-number">7.</span> <span class="nav-text">TfRecord</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#read"><span class="nav-number">7.1.</span> <span class="nav-text">read</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">7.2.</span> <span class="nav-text">write</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fintune"><span class="nav-number">8.</span> <span class="nav-text">Fintune</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Export-Graph"><span class="nav-number">9.</span> <span class="nav-text">Export Graph</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE%E9%9B%86COCO-VOC"><span class="nav-number">10.</span> <span class="nav-text">下载数据集COCO&amp;VOC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenImage-%E4%B8%8B%E8%BD%BD"><span class="nav-number">11.</span> <span class="nav-text">OpenImage 下载</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ShiXiaofeng"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">ShiXiaofeng</p>
  <div class="site-description" itemprop="description">LLM,搜索,数据挖掘,深度学习相关技术记录分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xiaofengShi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaofengShi" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sxf1052566766@163.com" title="E-Mail → mailto:sxf1052566766@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ShiXiaofeng</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v7.1.1
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '500px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el: '#valine-comments',
      verify: false,
      notify: false,
      appId: 'rBlWbsM2JDda6CTwJlGaUFpI-gzGzoHsz',
      appKey: 'zJasiQnAqgUwf4kiHhHyXwOP',
      placeholder: "Leave Your Message and Contact Details",
      avatar: 'mm',
      meta: guest,
      pageSize: '10' || 10,
      visitor: true,
      lang: '' || 'zh-cn',
      path: location.pathname,
      recordIP: false,
      serverURLs: ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
